{% extends "map.html" %}
{% load boxtag %} {# Custom tag defined in templatetags/ #}
{% block extrajs %}
  {{ block.super }}
  {% if theGuid %}
  <script type="text/javascript">
    $(function(){

      // TODO: remove the button and the following code
      $('#product-search-button').click(function(){
        $('#productIdForm').submit();
      });

      $('#productIdForm').submit(function(){
        $("#working").html('<p>Searching, please wait...<img src="/media/images/ajax-loader.gif"></p>');
        $("#working").slideDown('slow');
        $.ajax({
          type: "POST",
          url: "/productIdSearch/{{ theGuid }}/",
          data: $('#productIdForm').serialize(),
          success: function(data) {
            // Just in case...
            $('#productIdForm select').css({border: 'none'});
            $('#messages').hide();
            $('#search-messages').html('<b>' + data.count + '</b> record found for ' + data.messages.join(', ') + '.');
            $('#results-table').parent().load('/searchpage/{{ theGuid }}/',revealTable);
            $("#working").slideUp('slow');
          },
          error: function(data) {
            var errors = $.parseJSON (data.responseText);
            var messages = '';
            for (e in errors) {
              try {
                $('#id_' + e).css({border: 'solid 1px red'});
                messages += '<p>Errors in field <b>' + e + '</b>:<ul><li>';
                messages += errors[e].join('</li><li>');
                messages += '</ul></p>';
              } catch(e) {};
            }
            if (errors['__all__']) {
                messages += '<p>Errors in form :<ul><li>';
                messages += errors['__all__'].join('</li><li>');
                messages += '</ul></p>';
            }
            $('#id_sensors').css({border: 'solid 1px red'});
            $('#messages').html(messages).show('slow');
            $("#working").slideUp('slow');
          }
        });
        return false;
      });

      $('#productIdForm select').change(function() {
        $('#productIdForm').submit();
      });
    });
  </script>
  {% endif %}
{% endblock %}

{% block content %}
{% box_start "" "" "" %}
<div id="messages" style="display:none;background:white"></div>
<pre>SAT SEN TYP MOD YYMMDD HHMMSS</pre>
<ul id="product-id-search-list">
  <form id="productIdForm" action="/productIdSearch/{{ theGuid }}/">
  {% csrf_token %}
  {{myForm.as_ul}}
  </form>
</ul>
<input type="button" value="Search!" id="product-search-button" />
{% box_end %}
{{ block.super }}
{% endblock %}
