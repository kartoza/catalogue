<{% extends "base.html" %}
{% load compressed %}

{% block extracss %}
	{{ block.super }}
	{% compressed_css 'orderpage' %}
{% endblock %}

{% block content%}
  <div class="row">
  	<div class="span12">
  		<div id="map" class="order-map">
	  		<div id="map-controls" class="blackalpha60">
			    <div id="map-layerswitcher-control">
			      <button class="btn btn-info btn-large right icon-globe"></button>
			    </div>
				<div id="map-navigation"></div>
			</div>
			<div id="map-controls2" class="blackalpha60">
			    <div id="map-control-position"></div>
				<div id="map-control-scalebar"></div>  
			</div>
			<div id="map-layerswitcher" class="drop-shadow"></div>
		</div>
  	</div>
  </div>
  <div class="row">
  	<div class="span12">
  		<h2>Order options</h2>
  	</div>
  </div>
  <form enctype="multipart/form-data" action="" method="post" accept-charset="utf-8" class="form-horizontal" id="order-form">
      	{% csrf_token %}
      	<div class="row">
			<div class="span4">
				<div class="control-group">
					<label class="control-label">Projection</label>
				  	<label class="controls radio">
				    	<input type="radio" name="projectionRadio" id="projectionRadio1" value="0" checked>
				    	UTM
				  	</label>
				  	<label class="controls radio">
				    	<input type="radio" name="projectionRadio" id="projectionRadio1" value="1">
				    	Geographic
				  	</label>
				</div>
			</div>
			<div class="span4">
				<button type="button" class="btn" onclick="triggerProjectionChange('projection')">Apply</button>
			</div>
		</div>
		<div class="row">
			<div class="span12">
				<div class="control-group">
					<label class="control-label" for="{{ myOrderForm.datum.auto_id }}">{{ myOrderForm.datum.label }}</label>
					<div class="controls">
						{{ myOrderForm.datum }}
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="span4">
				<div class="control-group">
					<label class="control-label">Processing level</label>
				  	<label class="controls radio">
				    	<input type="radio" name="processingRadio" id="processingRadio1" value="1">
				    	Raw
				  	</label>
				  	<label class="controls radio">
				    	<input type="radio" name="processingRadio" id="processingRadio1" value="0" checked>
				    	Standard default
				  	</label>
				</div>
			</div>
			<div class="span4">
				<button type="button" class="btn" onclick="triggerProjectionChange('processing')">Apply</button>
			</div>
		</div>
		<div class="row">
			<div class="span12">
				<div class="control-group">
					<label class="control-label" for="{{ myOrderForm.resampling_method.auto_id }}">{{ myOrderForm.resampling_method.label }}</label>
					<div class="controls">
						{{ myOrderForm.resampling_method }}
					</div>
				</div>
				<hr />
			</div>
		</div>
		<div class="row">
			<div class="span6">
				<div class="control-group">
					<label class="control-label" for="{{ myOrderForm.file_format.auto_id }}">{{ myOrderForm.file_format.label }}</label>
					<div class="controls">
						{{ myOrderForm.file_format }}
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="{{ myOrderForm.delivery_method.auto_id }}">{{ myOrderForm.delivery_method.label }}</label>
					<div class="controls">
						{{ myOrderForm.delivery_method }}
					</div>
				</div>
				<hr />
				<div class="control-group">
					<label class="control-label" for="{{ myOrderForm.market_sector.auto_id }}">{{ myOrderForm.market_sector.label }}</label>
					<div class="controls">
						{{ myOrderForm.market_sector }}
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="{{ myOrderForm.subsidy_type_requested.auto_id }}">{{ myOrderForm.subsidy_type_requested.label }}</label>
					<div class="controls">
						{{ myOrderForm.subsidy_type_requested }}
					</div>
				</div>
				{% if user.is_staff %}
				<div class="control-group">
					<label class="control-label" for="{{ myOrderForm.subsidy_type_assigned.auto_id }}">{{ myOrderForm.subsidy_type_assigned.label }}</label>
					<div class="controls">
						{{ myOrderForm.subsidy_type_assigned }}
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="{{ myOrderForm.user.auto_id }}">{{ myOrderForm.user.label }}</label>
					<div class="controls">
						{{ myOrderForm.user }}
					</div>
				</div>
				{% endif %}
			</div>
			<div class="span6">
				<div class="control-group">
					<label class="control-label" for="{{ myOrderForm.notes.auto_id }}">{{ myOrderForm.notes.label }}</label>
					<div class="controls">
						{{ myOrderForm.notes }}
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="span12">
				<table class="table table-striped">
				<thead><tr>
					<th>Thumb</th>
					<th>Product</th>
					<th>Date</th>
					<th>Cloud</th>
					<th>Metadata</th>
					<th>Projection</th>
					<th>Processing level</th>
					<th>Cost</th>
					<th>Remove</th>
				</tr></thead>
				{% for record in myRecords %}
					<tr>
						<td><img src="/thumbnail/{{ record.product.id }}/small/"></td>
						<td>product</td>
						<td>{{ record.product.formated_date }}</td>
						<td>{{ record.product.getConcreteInstance.cloud_cover }}</td>
						<td><button class="btn btn-small metadata" data-id="{{ record.product.id }}" type="button"><i class="icon-list-alt"></i></button></td>
						{% autoescape off %}
						<td>
							<script>
								$(document.createElement('select')).deliveryOptions(
									{
										'data': $.parseJSON('{{ record.availableUTMZonesJSON }}'),
										'id': {{ record.product.id }},
										'type': 'projection'
									});
							</script>
						</td>
						<td>
							<script>
								$(document.createElement('select')).deliveryOptions(
									{
										'data': $.parseJSON('{{ record.availableProcessingLevelsJSON }}'),
										'id': {{ record.product.id }},
										'type': 'processing'
									});
							</script>
						</td>
						{% endautoescape %}
						<td id="{{ record.product.id }}_cost">
							<script>
								document.write(APP['widget_{{ record.product.id }}_processing'].getCost());
							</script>
						</td>
						<td><button class="btn btn-small btn-danger remove" data-id="{{ record.id }}" type="button"><i class="icon-trash"></i></button></td>
					</tr>
				{% endfor %}
				</table>
			</div>
		</div>
  </form>
  <div id="ajax-modal" class="modal hide fade" tabindex="-1"></div>
{% endblock %}

{% block extrajs %}
  {{ block.super }}
  {% compressed_js 'orderpage' %}
  <script>
  	var LayerSwitcherState = false;
    function toggleLayerSwitcher() {
	    if (LayerSwitcherState) {
	        $('#map-layerswitcher').hide();
	        $('#map-layerswitcher-control').css('color','#FFFFFF');
	        LayerSwitcherState = false;
	    } else {
	        $('#map-layerswitcher').show();
	        $('#map-layerswitcher-control').css('color','green');
	        LayerSwitcherState = true;
	    }
	}

	function triggerProjectionChange(option) {
		var type = $('input[name='+ option +'Radio]:radio:checked').val()
		if (type == 1) {
			var selector = 'option:last';
		} else {
			var selector = 'option:first';
		}
		$("select[name*='_"+option+"']").find(selector).attr("selected","selected");
	}

  	$( document ).ready(function() {
  		var myMap = new APP.SansaMap('map');
  		APP.$modal = $('#ajax-modal');
  		APP.CartRecords = {};

  		{% for record in myRecords %}
        APP.CartRecords['{{ record.id }}'] = {
          'wkt': '{{ record.product.spatial_coverage.wkt }}',
          'id': '{{ record.product.unique_product_id }}',
    	};
      	{% endfor %}
      	var cartLayer = new APP.CartLayer(myMap, {'wkt': APP.CartRecords});

		$('#map-layerswitcher-control').click(function() {
			toggleLayerSwitcher();
		});

		$('.metadata').click(function() {
			var id = $(this).data('id');
	        APP.$modal.load('/metadata/'+id, '', function(){
	            APP.$modal.modal();
	        });
		})

		$('.remove').click(function() {
			if (confirm('You are about to remove product from cart, are you sure?')) {
			    uiBlock();
			    var elem = $(this);
			    var id = elem.data('id');
			    $.get("/removefromcart/" + id + "/?xhr")
			    .done(function () {
			    	elem.parent().parent().remove();
			        cartLayer.removeFeature(id);
			    })
			    .fail(function () {
			      alert('There has been a problem!');
			    });
				uiUnblock();
			}
		})
    });
  </script>
{% endblock %}
