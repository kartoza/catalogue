{% extends "base.html" %}
{% load url from future %} {# https://docs.djangoproject.com/en/1.4/releases/1.3/#changes-to-url-and-ssi #}
{% block extrajs %}

  {{ block.super }}

  <script type="text/javascript">
  /* <![CDATA[ */
  {# use init rather than jquery document.ready() for ie support! #}
  function init() {

    if (OpenLayers.Util.getBrowserName() == "msie" && !window.ieLoaded) {
      window.ieLoaded = true;
      setTimeout(init, 2000);
      return;
    }

    // Extra layer definitions passed in by view
    {% if myLayerDefinitions %}
      {% for myValue in myLayerDefinitions %}
      {{ myValue|safe }}
      {% endfor %}
    {% endif %}
    var myLayersList = {{myLayersList|safe}}
    // Here we use a predefined layer that will be kept up to date with URL changes
    var layerMapnik = new OpenLayers.Layer.OSM.Mapnik("Open Street Map");
    //myLayersList.unshift(layerMapnik); // add to start of array
    myLayersList.push(layerMapnik); // add to end of array

    {% if myLayersList %}
      setupSearchMap( myLayersList );
    {% endif %}
    mMap.setBaseLayer( {{ myActiveBaseMap }} );
    setupMapHelpDialog();

    $('#OpenLayers_Control_MaximizeDiv_innerImage').css({'height':'100px'}); {# //dirty hack, OL sets 'style' element which cannot be overriden by CSS #}
    $("#map-container").mapResizer({'map':mMap});{# //activate mapresizer widget #}
    {# //add tooltip div #}
    $("#map-navigation-panel div[title],#resizer_toolbox img[title]").tooltip('#maptooltip');
    //removed tooltips as requested Story #65
    //$("#search-panel :input").tooltip('#formtooltip');
  }

    function check_sensor_inclination_angles() {
        var sv = parseInt($("#id_sensor_inclination_angle_start").val());
        var ev = parseInt($("#id_sensor_inclination_angle_end").val());
        if (sv && ev && (sv > ev)) {
            alert ("The sensor inclination angle start value is greater than the end.");
        };
    };

    {% if myAdvancedFlag %}{# activate advanced search tab #}
    $(function(){
        advSearchActivate({{ mySearchType }});
    });
    {% endif %}

    // ABP: new Ajax filtering
    // Set select options for sensor related dictionaries
    function set_form_options(options){
      $('#search_form select option').show();
      $('#search_form select option').each(function(_e, e){
        $(e).attr('disabled', false);
      });

      for (id in options) {
        try {
          //console.log('Checking ' + id);
          //console.log(options[id]);
          // To avoid hiding selected: " :not(:selected)"
          // To avoid filtering when the select has a value: "!$(e).parent().val() && "
          // To avoid filtering on multiple: "!$(e).parent().attr('multiple')"
          // Current logic: hide the options if the select has no value(s)
          $('#id_' + id + ' option').each(function(_e, e){
            if (e.value && $.inArray(parseInt(e.value), options[id]) == -1) {
              $(e).hide();
              $(e).attr('selected', false);
              $(e).attr('disabled', true);
              //console.log('hiding ' + id + ' val:' + e.value);
            } else {
              //console.log('no match ' + id + ' val:' + e.value);
            }
          });
        } catch(e) {
        };
      };
    };


    /* Ajax call to get options for sensor dictionaries */
    function get_dictionary_options(){
      block();
      $.ajax({
        type: "POST",
        url: "{% url 'getSensorDictionaries' %}",
        data: $('#search_form').serialize(),
        success: function(data) {
          // Just in case...
          $('#search_form select').css({border: 'none'});
          set_form_options(data);
          unblock();
        },
        error: function(data) {
          // No errors expected :)
          unblock();
        }
      });
    };

    $(function(){
      // Next line: uncomment to add a blank option to multiple selects
      //$('#search_form select[multiple="multiple"]:first-child').prepend('<option value="">---------</option>');
      $('#search_form .filter select').change(get_dictionary_options);
      {% if myAdvancedFlag %}// Filter initial options
      get_dictionary_options();
      {% endif %}


    });



  /* ]]> */
  </script>

{% endblock %}
{% block body_load %}onload="init()"{% endblock %}
{% block content%}
{# div for map tooltips - not shown until a map tool is hovered over #}
<div id="maptooltip">&nbsp;</div>
{# div for form tooltips (bigger than map tips)- not shown until a map tool is hovered over #}
{# removed tooltips as requested Story #65 #}
{# <div id="formtooltip">&nbsp;</div> #}
  <div class="row-fluid">
    <div id="map-container">
      <div id="map"></div>
      <div id="map-panel" class="row-fluid gap-top">
        <div id="map-navigation-panel" class="span4 center"></div>
        <div id="map-location" class="span4 center"></div>
        <div class="olControlScalebar span4 center" id="map-scale"></div>
      </div>
    </div>
  </div>
  <div id="search-panel" class="row-fluid">
    {% include "searchPanel.html" %}
  </div>
<script>
setTimeout(applyMapNavTooltips, 500);

function applyMapNavTooltips(){
      $('#map-navigation-panel > .icon-2x').each(function(){
        var title = $(this).attr('title');
        $(this).tooltip({
          placement:'bottom',
        });
      });
}
</script>
{% endblock%}












