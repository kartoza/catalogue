{# included in search.html or pulled in by ajax #}
{% load crispy_forms_tags %}

  {% if myForm %}
    <div id="search-headings" class="row-fluid gap-top center">
      <div class="btn-group">
        <button class="btn btn-info" id="advancedSearch" title="Click here to switch between simple and advanced search modes." onClick="toggleAdvFields();"><span id="search-btn-text">{% if myAdvancedFlag %}Activate Simple Search{% else %}Activate Advanced Search{% endif %}</span></button>
        <button onClick="submitSearchForm();" class="btn btn-success" class="default" name="_search" title="Click here to execute your search.">Search</button>
      </div>
    </div>
    <hr>
    <div class="row-fluid">
      <h3 class="center">Search Criteria<small> (you can optionally digitise a search area on the map)</small></h3>
      {% comment %}
      <form enctype="multipart/form-data" action="{% url 'search' %}" method="post" id="search_form" class="span12 form-horizontal gap-top">
        {% csrf_token %}
        {{myForm.geometry}}
        <div class="span5">
          {% for field in myForm.visible_fields|slice:":9" %}
            <div class="control-group">
              <label class="control-label" for="{{field.html_name}}"><strong>{{field.label}}:</strong></label>
              <div class="controls">
                {{field}}
                <span class="help-block">{{ field.help_text }}</span>
                {% if field.errors %}
                <span class="help-inline">{{ field.errors|striptags }}</span>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div> 
        <div class="span5">
          {% for field in myForm.visible_fields %}
          {% if forloop.counter >= 10 %}
            <div class="control-group">
              <label class="control-label" for="{{field.html_name}}"><strong>{{field.label}}:</strong></label>
              <div class="controls">
                {{field}}
                <span class="help-block">{{ field.help_text }}</span>
                {% if field.errors %}
                <span class="help-inline">{{ field.errors|striptags }}</span>
                {% endif %}
              </div>
            </div>
          {% endif %}
          {% endfor %}
        </div>        
      </form>
      {% endcomment %}
      {% crispy myForm %}
      {{myForm.media}}
    {% else %}
      Error search form could not be loaded.
    {% endif %}
  </div>
<script type="text/javascript">
  $('#dr_container').sansa_daterangecontainer();
  var advFieldsFlag = false;

  $('[data-search-type="adv"]').each(function(){
    $(this).hide();
    $(this).closest('.control-group').hide();
  });

  $('#id_start_datepicker, #id_end_datepicker').datepicker({
    'autoclose':true
  });

  {% if myAdvancedFlag %}
  toggleAdvFields();
  advFieldsFlag = true;
  {% endif %}

  {% for myField in myForm %}
  {% ifnotequal myField.html_name "geometry" %}
  $("#{{myField.html_name}}Help").dialog({
    autoOpen: false,
    bgiframe: true,
    modal: true,
    buttons: {
      Ok: function() {
        $(this).dialog('close');
      }
    }
  });
    $('#{{myField.html_name}}Button').click(function(){
      $('#{{myField.html_name}}Help').dialog('open');
  });
  {% endifnotequal %}
  {% endfor %}


  function toggleAdvFields(){
    if(!advFieldsFlag){
      advFieldsFlag = true;
      $('[data-search-type="adv"]').each(function(){
        $(this).fadeIn('slow');
        $(this).closest('.control-group').fadeIn('slow');
      });
      $('#search-btn-text').text('Activate Simple Search');
    } else {
      advFieldsFlag = false;
      $('[data-search-type="adv"]').each(function(){
        $(this).fadeOut('slow');
        $(this).closest('.control-group').fadeOut('slow');
      });
      $('#search-btn-text').text('Activate Advanced Search');
    }
  }

  function submitSearchForm(){
    check_search_dates();
    if (datesOk){
      document.forms["search_form"].submit();
    } else {
      alert ("The Start Date is later than the End Date.");
    }
  }

  function check_search_dates() {
    var datesOK;
    var sd = $("#id_start_datepicker").val();
    var ed = $("#id_end_datepicker").val();
    if (sd > ed) {
      datesOk=false;
    } else {
      datesOk=true;
    }
  }
</script>